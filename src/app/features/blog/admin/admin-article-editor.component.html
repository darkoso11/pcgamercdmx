<app-admin-header></app-admin-header>
<div class="min-h-screen bg-[#071029] p-6">
  <div class="max-w-5xl mx-auto">
  <h1 class="text-3xl font-bold text-cyan-400 mb-8">{{ isNew ? 'Nuevo Art√≠culo' : 'Editar Art√≠culo' }}</h1>
  
  <form [formGroup]="form" (ngSubmit)="onSave()" class="space-y-8">
    <!-- Secci√≥n: Informaci√≥n General -->
    <div class="bg-[#0b1220] border border-cyan-400/30 p-6 rounded-lg">
      <h2 class="text-xl font-bold text-cyan-400 mb-4">Informaci√≥n General</h2>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold text-cyan-400 mb-2 uppercase">T√≠tulo *</label>
          <input 
            type="text" 
            formControlName="title" 
            placeholder="Ej: Mi primer art√≠culo"
            class="w-full p-3 rounded bg-[#081229] border border-cyan-400/30 text-white placeholder-gray-500 focus:border-cyan-400 transition"
            required
          />
          <div *ngIf="form.get('title')?.hasError('required') && form.get('title')?.touched" 
            class="text-red-400 text-xs mt-1">T√≠tulo requerido</div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-cyan-400 mb-2 uppercase">Slug</label>
          <input 
            type="text" 
            formControlName="slug" 
            placeholder="mi-primer-articulo"
            class="w-full p-3 rounded bg-[#081229] border border-cyan-400/30 text-white placeholder-gray-500 focus:border-cyan-400 transition"
          />
          <div class="text-xs text-gray-400 mt-1">Se genera autom√°ticamente si dejas vac√≠o</div>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-cyan-400 mb-2 uppercase">Resumen (SEO) *</label>
        <textarea 
          formControlName="summary" 
          placeholder="Breve descripci√≥n del art√≠culo para listados y SEO"
          rows="3"
          class="w-full p-3 rounded bg-[#081229] border border-cyan-400/30 text-white placeholder-gray-500 focus:border-cyan-400 transition"
          required
        ></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-cyan-400 mb-2 uppercase">Categor√≠a *</label>
          <select 
            formControlName="categoryId" 
            class="w-full p-3 rounded bg-[#081229] border border-cyan-400/30 text-white focus:border-cyan-400 transition"
            required
          >
            <option value="">-- Seleccionar --</option>
            <option value="tech">Tecnolog√≠a</option>
            <option value="reviews">Rese√±as</option>
            <option value="tutorials">Tutoriales</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-cyan-400 mb-2 uppercase">Tags</label>
          <input 
            type="text" 
            formControlName="tags" 
            placeholder="ej: gaming, pc, hardware (separados por comas)"
            class="w-full p-3 rounded bg-[#081229] border border-cyan-400/30 text-white placeholder-gray-500 focus:border-cyan-400 transition"
          />
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Imagen de Portada -->
    <div class="bg-[#0b1220] border border-cyan-400/30 p-6 rounded-lg">
      <h2 class="text-xl font-bold text-cyan-400 mb-4">Imagen de Portada</h2>
      
      <div class="grid grid-cols-3 gap-4">
        <div class="col-span-2">
          <input 
            type="file" 
            accept="image/*" 
            (change)="onCoverImageSelect($event)"
            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700"
          />
          <div class="text-xs text-gray-400 mt-2">M√°ximo 5MB, formatos: JPG, PNG, WebP</div>
        </div>
        <button 
          type="button" 
          (click)="uploadCoverImage()" 
          [disabled]="!selectedCoverFile || uploading"
          class="bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
        >
          {{ uploading ? '‚è≥ Subiendo...' : 'üì§ Subir' }}
        </button>
      </div>

      <div *ngIf="coverImagePreview" class="mt-4">
        <img [src]="coverImagePreview" alt="Preview" class="max-w-xs rounded border border-cyan-400/30">
      </div>

      <div *ngIf="form.get('coverImage')?.value" class="mt-2 p-2 bg-green-500/20 border border-green-500 rounded text-sm text-green-300">
        ‚úì Imagen subida: {{ form.get('coverImage')?.value }}
      </div>
    </div>

    <!-- Secci√≥n: Secciones de Contenido -->
    <div class="bg-[#0b1220] border border-cyan-400/30 p-6 rounded-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-cyan-400">Secciones de Contenido</h2>
        <button 
          type="button" 
          (click)="addSection()"
          class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-semibold transition"
        >
          + Agregar Secci√≥n
        </button>
      </div>

      <div formArrayName="sections" class="space-y-6">
        <div *ngFor="let section of sectionsArray.controls; let i = index" 
          [formGroupName]="i"
          class="bg-[#081229] border border-cyan-400/20 p-4 rounded">
          
          <!-- Header de secci√≥n -->
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-bold text-cyan-300">Secci√≥n {{ i + 1 }}</h3>
            <button 
              type="button" 
              (click)="removeSection(i)"
              class="text-red-400 hover:text-red-300 font-bold"
            >
              ‚úï Eliminar
            </button>
          </div>

          <!-- T√≠tulo de secci√≥n -->
          <div class="mb-4">
            <label class="block text-sm font-semibold text-cyan-300 mb-2">T√≠tulo de Secci√≥n</label>
            <input 
              type="text" 
              formControlName="title" 
              placeholder="Ej: Introducci√≥n, Especificaciones, etc."
              class="w-full p-2 rounded bg-[#0b1220] border border-cyan-400/20 text-white placeholder-gray-500 focus:border-cyan-400 transition"
            />
          </div>

          <!-- Editor Quill para texto -->
          <div class="mb-4">
            <label class="block text-sm font-semibold text-cyan-300 mb-2">Contenido (HTML)</label>
            <quill-editor 
              formControlName="text" 
              [modules]="quillModules"
              class="rounded bg-white text-black"
            ></quill-editor>
          </div>

          <!-- Galer√≠a de Im√°genes de la Secci√≥n -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-3">
              <label class="block text-sm font-semibold text-cyan-300">Im√°genes de Secci√≥n</label>
              <button 
                type="button" 
                (click)="addImageToSection(i)"
                class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-semibold transition"
              >
                + Agregar Imagen
              </button>
            </div>

            <!-- Layout selector -->
            <div class="mb-3">
              <label class="text-xs text-cyan-300 mr-3">Columnas:</label>
              <select 
                formControlName="imageLayout"
                class="inline p-1 rounded bg-[#0b1220] border border-cyan-400/20 text-white text-xs"
              >
                <option value="1">1 columna</option>
                <option value="2">2 columnas</option>
                <option value="3">3 columnas</option>
                <option value="4">4 columnas</option>
              </select>
            </div>

            <!-- Grid de im√°genes -->
            <div [formArrayName]="'images'" class="space-y-3">
              <ng-container *ngFor="let imgCtrl of getSectionImages(i).controls; let imgIdx = index">
                <div [formGroupName]="imgIdx" class="bg-[#0b1220] border border-cyan-400/20 p-3 rounded">
                  <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-cyan-300">Imagen {{ imgIdx + 1 }}</span>
                    <button 
                      type="button" 
                      (click)="removeImageFromSection(i, imgIdx)"
                      class="text-red-400 hover:text-red-300 text-xs font-bold"
                    >
                      ‚úï
                    </button>
                  </div>

                  <input 
                    type="file" 
                    accept="image/*" 
                    (change)="onSectionImageSelect($event, i, imgIdx)"
                    class="block w-full text-xs text-gray-400 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700 mb-2"
                  />

                  <button 
                    type="button" 
                    (click)="uploadSectionImage(i, imgIdx)"
                    [disabled]="uploading"
                    class="bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 text-white px-2 py-1 rounded text-xs font-semibold transition mb-2"
                  >
                    {{ uploading ? '‚è≥' : 'üì§' }} Subir
                  </button>

                  <!-- Preview -->
                  <div *ngIf="(imgCtrl.value)?.preview" class="mb-2">
                    <img [src]="(imgCtrl.value).preview" alt="Preview" class="h-16 rounded border border-cyan-400/20">
                  </div>

                  <!-- Campo Alt -->
                  <input 
                    type="text" 
                    formControlName="alt" 
                    placeholder="Texto alternativo"
                    class="w-full p-1 rounded bg-[#081229] border border-cyan-400/20 text-white text-xs placeholder-gray-500 focus:border-cyan-400"
                  />

                  <div *ngIf="(imgCtrl.value)?.url" class="mt-1 text-xs text-green-300">
                    ‚úì URL: {{ (imgCtrl.value).url | slice:0:40 }}...
                  </div>
                </div>
              </ng-container>
            </div>

            <div *ngIf="getSectionImages(i).length === 0" class="text-xs text-gray-400 text-center py-3">
              Sin im√°genes. Haz clic en "+ Agregar Imagen"
            </div>
          </div>

          <!-- Orden de secci√≥n -->
          <div class="flex items-end gap-2">
            <div class="flex-1">
              <label class="block text-sm font-semibold text-cyan-300 mb-2">Orden</label>
              <input 
                type="number" 
                formControlName="order" 
                class="w-full p-2 rounded bg-[#0b1220] border border-cyan-400/20 text-white"
              />
            </div>
            <button 
              type="button" 
              (click)="moveSectionUp(i)"
              [disabled]="i === 0"
              class="bg-cyan-600 disabled:opacity-50 hover:bg-cyan-700 text-white px-3 py-2 rounded transition"
            >
              ‚Üë
            </button>
            <button 
              type="button" 
              (click)="moveSectionDown(i)"
              [disabled]="i === sectionsArray.length - 1"
              class="bg-cyan-600 disabled:opacity-50 hover:bg-cyan-700 text-white px-3 py-2 rounded transition"
            >
              ‚Üì
            </button>
          </div>
        </div>

        <div *ngIf="sectionsArray.length === 0" class="text-gray-400 text-center py-8">
          No hay secciones. Haz clic en "+ Agregar Secci√≥n" para empezar.
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Publicaci√≥n -->
    <div class="bg-[#0b1220] border border-cyan-400/30 p-6 rounded-lg">
      <h2 class="text-xl font-bold text-cyan-400 mb-4">Publicaci√≥n</h2>
      
      <label class="flex items-center gap-3">
        <input 
          type="checkbox" 
          formControlName="published"
          class="w-5 h-5 rounded cursor-pointer"
        />
        <span class="text-white font-semibold">Publicar ahora</span>
      </label>
      <div class="text-xs text-gray-400 mt-2">
        Si est√° marcado, el art√≠culo ser√° visible p√∫blicamente en /blog
      </div>
    </div>

    <!-- Mensajes de estado -->
    <div *ngIf="errorMsg" class="p-4 bg-red-500/20 border border-red-500 rounded text-red-300">
      ‚ùå {{ errorMsg }}
    </div>
    <div *ngIf="successMsg" class="p-4 bg-green-500/20 border border-green-500 rounded text-green-300">
      ‚úì {{ successMsg }}
    </div>

    <!-- Botones de acci√≥n -->
    <div class="flex gap-3 justify-end">
      <a 
        routerLink="/admin/blog" 
        class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded font-semibold transition"
      >
        Cancelar
      </a>
      <button 
        type="submit" 
        [disabled]="form.invalid || saving"
        class="bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded font-semibold transition"
      >
        {{ saving ? '‚è≥ Guardando...' : (isNew ? '‚úì Crear Art√≠culo' : '‚úì Guardar Cambios') }}
      </button>
    </div>
  </form>
  </div>
